# webRotas Architecture Diagrams\n\n## 1. Current (Problematic) Architecture\n\n### Module Organization\n\n```\nsrc/webrotas/\nâ”‚\nâ”œâ”€â”€ ğŸ”´ MIXED RESPONSIBILITIES (11 root modules)\nâ”œâ”€â”€ rotas.py                      Domain logic\nâ”œâ”€â”€ api_routing.py                âš ï¸  MONOLITHIC (600+ lines, 5+ concerns)\nâ”œâ”€â”€ zone_aware_routing.py         Domain logic\nâ”œâ”€â”€ segment_alternatives.py       Domain logic  \nâ”œâ”€â”€ iterative_matrix_builder.py   Infrastructure\nâ”œâ”€â”€ api_elevation.py              Infrastructure\nâ”œâ”€â”€ shapefiles.py                 Infrastructure\nâ”œâ”€â”€ regions.py                    Utilities\nâ”œâ”€â”€ geojson_converter.py          Utilities\nâ”œâ”€â”€ lua_converter.py              Utilities\nâ”œâ”€â”€ version_manager.py            Utilities\nâ”œâ”€â”€ server_env.py                 Configuration âš ï¸ Orphaned\nâ”‚\nâ””â”€â”€ api/                          âœ“ Well-structured\n    â”œâ”€â”€ routes/\n    â”œâ”€â”€ models/\n    â””â”€â”€ __init__.py\n```\n\n### Import Graph (Chaotic)\n\n```\n                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n                  â”‚      API Layer                      â”‚\n                  â”‚  process_route (services)          â”‚\n                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n                           â”‚\n          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n          â”‚                â”‚                â”‚\n          â–¼                â–¼                â–¼\n    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n    â”‚ rotas.py     â”‚ â”‚api_routing.pyâ”‚ â”‚shapefiles.py â”‚ âš ï¸ No clear layers\n    â”‚RouteProcessorâ”‚ â”‚   (HUGE!)    â”‚ â”‚              â”‚\n    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n            â”‚              â”‚\n        â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”\n        â”‚                          â”‚\n        â–¼                          â–¼\n  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n  â”‚segment_         â”‚    â”‚zone_aware_routing.py â”‚ ğŸ˜• Spaghetti code\n  â”‚alternatives.py  â”‚    â”‚                      â”‚\n  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n        â”‚                          â”‚\n        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n                    â”‚\n                    â–¼\n        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n        â”‚ Utilities scattered   â”‚\n        â”‚ everywhere (mixed     â”‚\n        â”‚ with business logic)  â”‚ âŒ Bad separation\n        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n### Problem: api_routing.py Unmaintainability\n\n```\napi_routing.py (600+ lines)\nâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                                                 â”‚\nâ”‚  process_avoidzones()         â† Zone processing â”‚ Domain\nâ”‚  load_spatial_index()         â† Spatial ops     â”‚ Domain\nâ”‚  check_route_intersections()  â† Analysis        â”‚ Domain\nâ”‚                                                 â”‚\nâ”‚  request_osrm()               â† OSRM API        â”‚ Infrastructure\nâ”‚  calculate_optimal_route()    â† Routing         â”‚ Infrastructure\nâ”‚  optimize_route_with_ortools()â† Optimization   â”‚ Domain\nâ”‚                                                 â”‚\nâ”‚  (Constants, utilities, etc.)                  â”‚ Misc\nâ”‚                                                 â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n         âŒ Cannot be tested in isolation\n         âŒ Cannot be cached independently\n         âŒ High cyclomatic complexity\n         âŒ Hard to reuse individual functions\n```\n\n---\n\n## 2. Proposed (Clean) Architecture\n\n### Layered Organization\n\n```\n                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n                         â”‚   Entry Point                â”‚\n                         â”‚   main.py                    â”‚\n                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n                                      â”‚\n                                      â–¼\n             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n             â”‚         ğŸ”µ API LAYER                          â”‚\n             â”‚  (FastAPI endpoints, request/response)        â”‚\n             â”‚                                                â”‚\n             â”‚  â”œâ”€ routes/process.py   (POST /process)       â”‚\n             â”‚  â”œâ”€ routes/health.py    (GET /ok)             â”‚\n             â”‚  â”œâ”€ models/requests.py  (DTOs)                â”‚\n             â”‚  â”œâ”€ middleware/         (validation, errors)  â”‚\n             â”‚  â””â”€ services/           (orchestration)       â”‚\n             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜\n                          â”‚                            â”‚\n              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n              â”‚                      â”‚    â”‚                       â”‚\n              â–¼                      â–¼    â–¼                       â–¼\n      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n      â”‚ ğŸŸ¢ DOMAIN LAYER  â”‚  â”‚ ğŸŸ  INFRASTRUCTURE LAYER â”‚  â”‚ ğŸŸ¡ UTILITIES  â”‚\n      â”‚ (Pure Logic)     â”‚  â”‚ (External Services)     â”‚  â”‚ (Helpers)      â”‚\n      â”‚                  â”‚  â”‚                         â”‚  â”‚                â”‚\n      â”‚ routing/         â”‚  â”‚ routing/                â”‚  â”‚ converters/    â”‚\n      â”‚ â”œâ”€processor.py   â”‚  â”‚ â”œâ”€osrm.py              â”‚  â”‚ â”œâ”€geojson.py  â”‚\n      â”‚ â”œâ”€zone_aware.py  â”‚  â”‚ â””â”€matrix_builder.py    â”‚  â”‚ â””â”€lua.py      â”‚\n      â”‚ â””â”€alternatives.pyâ”‚  â”‚                         â”‚  â”‚                â”‚\n      â”‚                  â”‚  â”‚ elevation/              â”‚  â”‚ versioning/    â”‚\n      â”‚ avoid_zones/     â”‚  â”‚ â””â”€service.py            â”‚  â”‚ â””â”€version_     â”‚\n      â”‚ â”œâ”€processor.py   â”‚  â”‚                         â”‚  â”‚   manager.py  â”‚\n      â”‚ â””â”€spatial.py     â”‚  â”‚ geospatial/             â”‚  â”‚                â”‚\n      â”‚                  â”‚  â”‚ â”œâ”€shapefiles.py         â”‚  â”‚ cache/         â”‚\n      â”‚ geospatial/      â”‚  â”‚ â””â”€loaders.py            â”‚  â”‚ â”œâ”€polylines.py â”‚\n      â”‚ â”œâ”€bounding_box.pyâ”‚  â”‚                         â”‚  â”‚ â”œâ”€routes.py   â”‚\n      â”‚ â””â”€regions.py     â”‚  â”‚                         â”‚  â”‚ â””â”€bounding_    â”‚\n      â”‚                  â”‚  â”‚                         â”‚  â”‚   boxes.py     â”‚\n      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n              â–²                      â”‚                           â”‚\n              â”‚                      â”‚                           â”‚\n              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚\n                   (Inject)          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n      \n      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n      â”‚ ğŸ”· CORE LAYER (Foundation)                              â”‚\n      â”‚  â€¢ exceptions.py   - App exceptions                     â”‚\n      â”‚  â€¢ dependencies.py - FastAPI dependencies              â”‚\n      â”‚  â€¢ logger.py       - Logging                            â”‚\n      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n      \n      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n      â”‚ âš™ï¸ CONFIG LAYER (Configuration)                         â”‚\n      â”‚  â€¢ constants.py    - App constants                      â”‚\n      â”‚  â€¢ server_hosts.py - Server URLs                        â”‚\n      â”‚  â€¢ server_env.py   - Runtime environment                â”‚\n      â”‚  â€¢ logging_config.py - Logging config                   â”‚\n      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n### Clean Dependency Flow\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                         API LAYER                               â”‚\nâ”‚  â€¢ process.py endpoint                                          â”‚\nâ”‚  â€¢ process_route() service                                      â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n             â”‚                                      â”‚\n     â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n     â”‚  DOMAIN LAYER       â”‚              â”‚ INFRASTRUCTURE    â”‚\n     â”‚  RouteProcessor     â”‚â”€injectionâ”€â”€â”€â†’â”‚ OSRMClient        â”‚\n     â”‚  âœ“ Pure logic       â”‚              â”‚ âœ“ External calls  â”‚\n     â”‚  âœ“ No I/O           â”‚              â”‚ âœ“ Data access     â”‚\n     â”‚  âœ“ Testable         â”‚              â”‚                   â”‚\n     â”‚  âœ“ Mockable         â”‚              â”‚ Elevation API     â”‚\n     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚ Shapefiles        â”‚\n                â”‚                          â”‚ Matrix builder    â”‚\n                â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n                               â”‚\n                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n                    â”‚  UTILS LAYER         â”‚\n                    â”‚  Converters, Cache   â”‚\n                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n\nğŸŸ¢ Dependency Rule: Arrows ONLY point downward\nâŒ NO upward dependencies\nâŒ NO sideways dependencies (same layer)\n```\n\n---\n\n## 3. Comparison: Import Complexity\n\n### Before (Complex, Unclear)\n\n```\nservices/route_service.py\n    â”‚\n    â”œâ”€â†’ from webrotas.rotas import RouteProcessor\n    â”‚       â””â”€â†’ imports from api_routing (mixed layer!)\n    â”‚\n    â”œâ”€â†’ from webrotas.api_routing import calculate_optimal_route\n    â”‚       â””â”€â†’ infrastructure + domain mixed\n    â”‚\n    â”œâ”€â†’ from webrotas.api_elevation import enrich_waypoints_with_elevation\n    â”‚       â””â”€â†’ infrastructure\n    â”‚\n    â”œâ”€â†’ from webrotas.shapefiles import get_areas_urbanas_cache\n    â”‚       â””â”€â†’ infrastructure (geospatial)\n    â”‚\n    â””â”€â†’ from webrotas.regions import extrair_bounding_box_de_regioes\n            â””â”€â†’ utilities? or domain?\n\nâŒ 5 import sources\nâŒ Unclear which layer each is in\nâŒ No pattern to follow for new code\nâŒ Easy to create circular dependencies\n```\n\n### After (Clear, Structured)\n\n```\napi/services/route_service.py\n    â”‚\n    â”œâ”€â†’ from webrotas.domain.routing.processor import RouteProcessor\n    â”‚       â””â”€â†’ Domain layer (pure logic)\n    â”‚\n    â”œâ”€â†’ from webrotas.infrastructure.routing.osrm import OSRMClient\n    â”‚       â””â”€â†’ Infrastructure layer (OSRM API)\n    â”‚\n    â”œâ”€â†’ from webrotas.infrastructure.elevation.service import enrich_waypoints\n    â”‚       â””â”€â†’ Infrastructure layer (elevation service)\n    â”‚\n    â”œâ”€â†’ from webrotas.infrastructure.geospatial.shapefiles import get_areas\n    â”‚       â””â”€â†’ Infrastructure layer (data access)\n    â”‚\n    â””â”€â†’ from webrotas.domain.geospatial.regions import extrair_bounding_box\n            â””â”€â†’ Domain layer (region logic)\n\nâœ“ Clear layer organization (prefix)\nâœ“ Immediately visible which are external services\nâœ“ Obvious where new code should go\nâœ“ Dependency flow is enforced by structure\n```\n\n---\n\n## 4. Module Responsibilities (Before vs After)\n\n### BEFORE: Unclear Responsibilities\n\n```\napi_routing.py (600+ lines, 5+ concerns)\nâ”œâ”€ What is its primary responsibility?\nâ”‚  \"Routing\"? \"API\"? \"Zone processing\"?\nâ”‚\nâ”œâ”€ What's the complexity?\nâ”‚  âœ— Mix of domain and infrastructure\nâ”‚  âœ— Mix of synchronous and async\nâ”‚  âœ— Multiple algorithms in one file\nâ”‚\nâ””â”€ Testing strategy?\n   âœ— Hard to unit test (coupled to OSRM)\n   âœ— Can't mock without complex setup\n   âœ— Brittle and slow tests\n```\n\n### AFTER: Clear Single Responsibility\n\n```\ninfrastructure/routing/osrm.py\nâ”œâ”€ Primary: OSRM API client implementation\nâ”œâ”€ Responsibility: HTTP calls to OSRM server\nâ”œâ”€ Complexity: Manages external service communication\nâ””â”€ Testing: Easy to mock with AsyncMock\n    âœ“ Inject mock OSRMClient\n    âœ“ Test without real server\n    âœ“ Fast tests\n\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\ndomain/avoid_zones/processor.py\nâ”œâ”€ Primary: Avoid zones business logic\nâ”œâ”€ Responsibility: Zone processing algorithms\nâ”œâ”€ Complexity: Pure logic, no I/O\nâ””â”€ Testing: Easy to unit test\n    âœ“ No mocking needed\n    âœ“ Test various scenarios\n    âœ“ Very fast tests\n\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\ndomain/avoid_zones/spatial.py\nâ”œâ”€ Primary: Spatial indexing operations\nâ”œâ”€ Responsibility: Spatial analysis (Shapely, STRtree)\nâ”œâ”€ Complexity: Pure geometric computation\nâ””â”€ Testing: Easy to unit test\n    âœ“ Pure functions\n    âœ“ Test with fixture data\n    âœ“ No external dependencies\n```\n\n---\n\n## 5. Dependency Injection Pattern\n\n### Current: Direct Coupling âŒ\n\n```python\n# rotas.py\nclass RouteProcessor:\n    async def process_shortest(self, ...):\n        # Direct call - cannot mock\n        origin, waypoints = await calculate_optimal_route(...)\n        \n        # Problem: If OSRM is down, test fails\n        # Solution: Can't easily test this in isolation\n```\n\n### Proposed: Dependency Injection âœ…\n\n```python\n# domain/routing/processor.py\nfrom webrotas.infrastructure.routing.osrm import OSRMClient\n\nclass RouteProcessor:\n    def __init__(self, ..., osrm_client: OSRMClient = None):\n        # Accept injected dependency\n        self.osrm_client = osrm_client or OSRMClient()\n    \n    async def process_shortest(self, ...):\n        # Uses injected client - can be mocked\n        origin, waypoints = await self.osrm_client.calculate_optimal_route(...)\n\n# In tests:\n@pytest.mark.asyncio\nasync def test_process_shortest():\n    # Inject mock\n    mock_osrm = AsyncMock(spec=OSRMClient)\n    processor = RouteProcessor(..., osrm_client=mock_osrm)\n    \n    # Test without real OSRM server\n    await processor.process_shortest(...)\n    mock_osrm.calculate_optimal_route.assert_called_once()\n```\n\n---\n\n## 6. Module Size Comparison\n\n### Before: Large Monoliths\n\n```\nğŸ“„ rotas.py                      ~400 lines  (RouteProcessor + helpers)\nğŸ“„ api_routing.py                ~600 lines  âš ï¸  (HUGE - 5 concerns)\nğŸ“„ zone_aware_routing.py         ~300 lines  (Zone logic)\nğŸ“„ segment_alternatives.py       ~250 lines  (Alternatives)\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n   Total: ~1550 lines in 4 modules\n   Average: 387 lines per module âŒ\n```\n\n### After: Focused Modules\n\n```\nğŸ“„ domain/routing/processor.py           ~200 lines  âœ“\nğŸ“„ domain/routing/zone_aware.py          ~200 lines  âœ“\nğŸ“„ domain/routing/alternatives.py        ~200 lines  âœ“\nğŸ“„ domain/avoid_zones/processor.py       ~100 lines  âœ“\nğŸ“„ domain/avoid_zones/spatial.py         ~150 lines  âœ“\nğŸ“„ infrastructure/routing/osrm.py        ~250 lines  âœ“\nğŸ“„ infrastructure/routing/matrix_builder.py ~200 lines âœ“\nğŸ“„ infrastructure/elevation/service.py   ~50 lines   âœ“\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n   Total: ~1350 lines in 8 modules\n   Average: 169 lines per module âœ“\n```\n\n**Result**: \n- âœ“ 56% fewer lines per module\n- âœ“ Each module has single focus\n- âœ“ Easier to understand\n- âœ“ Easier to test\n\n---\n\n## 7. Feature Addition Flow\n\n### Before: Where do I add new code?\n\n```\n\"I need to add a new routing strategy\"\n\nOptions:\nâ”œâ”€ Add to rotas.py?               (Maybe)\nâ”œâ”€ Add to api_routing.py?         (No, it's infrastructure)\nâ”œâ”€ Create new file?               (Where?)\nâ”œâ”€ Add to zone_aware_routing.py?  (No, different concern)\nâ””â”€ â“ I don't know!\n\nâ†’ Developer confusion\nâ†’ Inconsistent patterns\nâ†’ Code spread across multiple modules\n```\n\n### After: Clear structure\n\n```\n\"I need to add a new routing strategy\"\n\nâœ“ OBVIOUS: Create domain/routing/new_strategy.py\n\nâ”œâ”€ If it's pure algorithm\nâ”‚  â””â”€â†’ domain/routing/new_strategy.py\nâ”‚\nâ”œâ”€ If it needs OSRM calls\nâ”‚  â””â”€â†’ Add method to infrastructure/routing/osrm.py\nâ”‚      Call from domain/routing/processor.py\nâ”‚\nâ”œâ”€ If it uses existing patterns\nâ”‚  â””â”€â†’ Copy domain/routing/zone_aware.py as template\nâ”‚\nâ””â”€ Integration\n    â””â”€â†’ Add case in api/services/route_service.py\n    \nâ†’ Clear guidance\nâ†’ Consistent patterns\nâ†’ Easy to follow\n```\n\n---\n\n## 8. Testing Strategy Improvement\n\n### Before: Difficult Integration Tests\n\n```\ntest_enhanced_routing.py\n    â”œâ”€ Imports: from webrotas.rotas import RouteProcessor\n    â”‚           from webrotas.api_routing import calculate_optimal_route\n    â”‚\n    â”œâ”€ Setup: Mock OSRM server, mock shapefiles, etc.\n    â”‚  â€¢ Complex setup\n    â”‚  â€¢ Many patches required\n    â”‚  â€¢ Tests are slow (I/O waits)\n    â”‚\n    â”œâ”€ Testing:\n    â”‚  âŒ Cannot test domain logic alone\n    â”‚  âŒ Cannot test OSRM integration alone\n    â”‚  âŒ Tests are fragile (depend on multiple services)\n    â”‚\n    â””â”€ Result: Integration tests only, no unit tests\n```\n\n### After: Clear Unit + Integration Tests\n\n```\ntests/unit/domain/\nâ”œâ”€ test_routing_processor.py\nâ”‚  â”œâ”€ Test with mocked OSRMClient\nâ”‚  â”œâ”€ Fast (no I/O)\nâ”‚  â””â”€ Focused (one concern)\nâ”‚\nâ”œâ”€ test_zone_aware_routing.py\nâ”‚  â”œâ”€ Pure algorithm tests\nâ”‚  â”œâ”€ No mocking needed\nâ”‚  â””â”€ Instant feedback\nâ”‚\nâ””â”€ test_spatial_indexing.py\n   â”œâ”€ Geometric operations\n   â”œâ”€ Sample data\n   â””â”€ Fast\n\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\ntests/unit/infrastructure/\nâ”œâ”€ test_osrm_client.py\nâ”‚  â”œâ”€ Mock HTTP responses\nâ”‚  â”œâ”€ Test error handling\nâ”‚  â””â”€ No real OSRM needed\nâ”‚\nâ””â”€ test_matrix_builder.py\n   â”œâ”€ Mock API responses\n   â””â”€ Test batch logic\n\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\ntests/integration/\nâ”œâ”€ test_route_end_to_end.py\nâ”‚  â”œâ”€ Full flow (with real services)\nâ”‚  â”œâ”€ Runs with Docker OSRM\nâ”‚  â””â”€ Less frequent (slower)\n```\n\n**Result**:\n- âœ“ Fast unit tests (most tests)\n- âœ“ Clear integration tests\n- âœ“ Easier to debug failures\n- âœ“ Better test coverage\n\n---\n\n## 9. Scaling Example: Adding New Feature\n\n### Scenario: Add elevation caching feature\n\n#### Before: Scattered across files\n```\nrequired changes:\nâ”œâ”€ api_routing.py      (modify calculate_optimal_route)\nâ”œâ”€ rotas.py            (modify process_shortest)\nâ”œâ”€ api_elevation.py    (add caching logic)\nâ”œâ”€ new file? cache/elevation_cache.py?\nâ””â”€ tests scattered everywhere\n\nâŒ Hard to find all affected code\nâŒ High risk of breaking something\nâŒ Unclear if changes are complete\n```\n\n#### After: Localized changes\n```\nrequired changes:\nâ”œâ”€ utils/cache/elevation.py          â† New cache logic (isolated)\nâ”œâ”€ infrastructure/elevation/service.py â† Use cache (clear responsibility)\nâ”œâ”€ tests/unit/utils/test_elevation_cache.py    â† Unit tests\nâ”œâ”€ tests/integration/test_elevation_caching.py â† Integration test\nâ””â”€ domain/routing/processor.py        â† No changes needed!\n\nâœ“ Easy to find all affected code\nâœ“ Changes are localized\nâœ“ Clear scope of changes\nâœ“ Easy to review in PR\nâœ“ Easy to revert if needed\n```\n\n---\n\n## Summary\n\n| Aspect | Before | After |\n|--------|--------|-------|\n| **Organization** | Flat, 11 modules | Layered, 5 main groups |\n| **Avg Module Size** | 387 lines | 169 lines |\n| **Clarity** | Unclear layers | Crystal clear |\n| **Testability** | Integration only | Unit + Integration |\n| **Dependency Flow** | Tangled, circular risk | Unidirectional |\n| **New Feature** | \"Where do I add this?\" | Obvious location |\n| **Scaling** | High cognitive load | Easy to extend |\n| **Maintenance** | Difficult | Straightforward |\n\n**Conclusion**: Layered architecture provides significantly better organization, testability, and maintainability.\n"