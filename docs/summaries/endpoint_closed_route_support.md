# Endpoint and Closed Route Support\n\n## Overview\nImplemented support for defining specific route endpoints and closed tours (returns to origin). This allows routes to be optimized with constraints on where they must end, useful for scenarios like delivery routes that must return to depot or inspections that must end at a specific facility.\n\n## Problem Statement\nPreviously, all routes were open tours starting at origin and ending at any waypoint. This limitation prevented:\n- Routes that must return to depot (closed tours)\n- Routes that must end at a specific waypoint\n- Combined constraints (e.g., closed route but consider all waypoints)\n\n## Solution Implemented\n\n### 1. Request Model Updates\n**File:** `src/webrotas/api/models/requests.py`\n\nAdded two optional fields to `RouteRequest`:\n```python\nendpoint: Optional[Origin] = Field(\n    default=None,\n    description=\"Optional endpoint where route must end (must be one of the waypoints)\"\n)\nclosed: Optional[bool] = Field(\n    default=False,\n    description=\"If true, route returns to origin (closed tour)\"\n)\n```\n\nBoth fields are optional and default to current behavior (open tour with no specific endpoint).\n\n### 2. TSP Solver Enhancements\n**File:** `src/webrotas/infrastructure/routing/osrm.py`\n\nAdded three new TSP solving functions:\n\n#### `solve_closed_tsp_from_matrix(distance_matrix)`\n- Solves closed Traveling Salesman Problem (Hamiltonian circuit)\n- Route starts at node 0 and returns to node 0\n- Returns order including final return: `[0, 3, 1, 2, 0]`\n\n#### `solve_constrained_tsp_from_matrix(distance_matrix, start_index=0, end_index=None)`\n- Solves TSP with fixed start and end nodes\n- Creates open tour from start_index to end_index\n- Post-processes solution to ensure end_index is last node if specified\n\n#### `solve_tsp_from_matrix(distance_matrix, criterion=\"distance\", endpoint_index=None, closed=False)`\n- Dispatcher function that selects appropriate solver\n- Validates constraint combinations (e.g., closed=True + endpoint != origin returns error)\n- Calls appropriate underlying function based on parameters\n\n### 3. Route Order Calculation Updates\n**File:** `src/webrotas/infrastructure/routing/osrm.py`\n\nModified `_calculate_route_order()` to accept:\n- `endpoint_index: int | None` - index of required endpoint\n- `closed: bool` - whether route should return to origin\n\nPasses these to `solve_tsp_from_matrix()` dispatcher.\n\n### 4. Optimal Route Calculation Updates\n**File:** `src/webrotas/infrastructure/routing/osrm.py`\n\nExtended `calculate_optimal_route()` signature:\n```python\nasync def calculate_optimal_route(\n    origin,\n    waypoints,\n    criterion: str = \"distance\",\n    avoid_zones: List | None = None,\n    endpoint: Dict[str, float] | None = None,  # NEW\n    closed: bool = False,  # NEW\n)\n```\n\n**Key functionality:**\n- Validates endpoint/closed constraint combinations\n- Maps endpoint coordinate to its index in origin+waypoints\n- Handles filtered waypoints by remapping endpoint_index\n- Passes constraints to TSP solver\n\n### 5. RouteProcessor Integration\n**File:** `src/webrotas/domain/routing/processor.py`\n\n#### For `process_shortest()`, `process_circle()`, `process_grid()`:\n- Extracts endpoint and closed from request\n- Passes to `calculate_optimal_route()`\n- TSP solver automatically handles constraints\n\n#### For `process_ordered()` with criterion=\"ordered\":\n- Adjusted coordinate list before calling `calculate_ordered_route()`\n- If `closed=True`: appends origin to end of waypoints\n- If `endpoint` specified: moves endpoint to end of waypoints\n- Skips matrix calculation and TSP (already specified order)\n\n#### For `process_ordered()` with criterion=\"distance\" or \"duration\":\n- Passes endpoint and closed to `calculate_optimal_route()`\n- Full TSP optimization applied (endpoint/closed are constraints)\n\n## Usage Examples\n\n### Open Tour (Default Behavior)\n```json\n{\n  \"type\": \"shortest\",\n  \"origin\": {\"lat\": 0, \"lng\": 0, \"description\": \"Start\"},\n  \"parameters\": {\n    \"waypoints\": [\n      {\"lat\": 1, \"lng\": 1, \"description\": \"Point A\"},\n      {\"lat\": 2, \"lng\": 2, \"description\": \"Point B\"}\n    ]\n  }\n}\n```\nResult: Route optimizes order, ends at best location.\n\n### Closed Tour (Return to Origin)\n```json\n{\n  \"type\": \"shortest\",\n  \"origin\": {\"lat\": 0, \"lng\": 0, \"description\": \"Depot\"},\n  \"parameters\": {\n    \"waypoints\": [\n      {\"lat\": 1, \"lng\": 1, \"description\": \"Point A\"},\n      {\"lat\": 2, \"lng\": 2, \"description\": \"Point B\"}\n    ]\n  },\n  \"closed\": true\n}\n```\nResult: Route optimizes order and returns to origin.\n\n### Fixed Endpoint\n```json\n{\n  \"type\": \"shortest\",\n  \"origin\": {\"lat\": 0, \"lng\": 0, \"description\": \"Start\"},\n  \"parameters\": {\n    \"waypoints\": [\n      {\"lat\": 1, \"lng\": 1, \"description\": \"Point A\"},\n      {\"lat\": 2, \"lng\": 2, \"description\": \"Point B\"}\n    ]\n  },\n  \"endpoint\": {\"lat\": 2, \"lng\": 2, \"description\": \"Point B\"}\n}\n```\nResult: Route optimizes order, ends at Point B.\n\n### Ordered Type with Closed\n```json\n{\n  \"type\": \"ordered\",\n  \"criterion\": \"ordered\",\n  \"origin\": {\"lat\": 0, \"lng\": 0, \"description\": \"Start\"},\n  \"parameters\": {\n    \"waypoints\": [\n      {\"lat\": 1, \"lng\": 1, \"description\": \"A\"},\n      {\"lat\": 2, \"lng\": 2, \"description\": \"B\"}\n    ]\n  },\n  \"closed\": true\n}\n```\nResult: Routes A→B→Start (closed), no TSP optimization.\n\n## Backward Compatibility\n- All new fields are optional with safe defaults\n- Existing requests without endpoint/closed work unchanged\n- Default behavior is open tour (no return to origin)\n- No breaking changes to API\n\n## Error Handling\n\n### Validation Errors (HTTP 422)\n1. **Conflicting constraints**: `closed=true` AND `endpoint` that differs from origin\n   - Message: \"Cannot specify both closed=true and endpoint different from origin\"\n\n2. **Invalid endpoint**: Endpoint coordinate not found in origin or waypoints\n   - Message: \"Endpoint coordinate not found in origin or waypoints\"\n\n### Filtered Endpoint\nIf endpoint is inside an exclusion zone and gets filtered:\n- Logs warning: \"Endpoint at index X was filtered out; using open tour instead\"\n- Treats as open tour (endpoint_index becomes None)\n- Route still routes successfully with remaining waypoints\n\n## Performance Considerations\n\n### Closed Tour Performance\n- Requires solving actual Hamiltonian circuit (more computationally intensive)\n- OR-Tools handles this efficiently with PATH_CHEAPEST_ARC heuristic\n- Solution time similar to open tour due to heuristic approach\n\n### Fixed Endpoint Performance\n- Post-processes solution to move endpoint to end\n- Minimal performance impact vs. open tour\n- More efficient than running separate optimization\n\n### Ordered Routes with Endpoint/Closed\n- Skips matrix calculation and TSP entirely\n- Simply rearranges waypoints to satisfy constraints\n- Most efficient option if order is already known\n\n## Technical Details\n\n### OR-Tools Configuration\n\n**Closed Tour:**\n```python\n# No free-return trick; full cost matrix used\n# RoutingIndexManager creates circuit by default\nmanager = pywrapcp.RoutingIndexManager(n, 1, 0)\nrouting = pywrapcp.RoutingModel(manager)\n# Solver finds circuit (returns to start)\n```\n\n**Fixed Endpoint:**\n```python\n# Free-return trick: zero cost to start_index\n# But then move endpoint to end after solving\ndm[ii][start_index] = 0  # for all ii != start_index\n# After solution: move endpoint_index to last position\n```\n\n### Coordinate Mapping\nWhen waypoints are filtered by exclusion zones:\n- Original indices may change\n- `valid_indices` maps filtered→original indices\n- endpoint_index is remapped before TSP solving\n- Post-processing converts solution back to original indices\n\n## Testing Examples\n\n### Test 1: Open Tour (Baseline)\nRequest without endpoint/closed → same results as before\n\n### Test 2: Simple Closed Route\n- 3 waypoints\n- Verify last waypoint equals origin\n- Verify path is optimized\n\n### Test 3: Fixed Endpoint\n- 4 waypoints, endpoint specified\n- Verify last waypoint equals endpoint\n- Verify path is optimized\n\n### Test 4: Invalid Constraint\n- closed=true + endpoint != origin\n- Expect HTTP 422 with clear message\n\n### Test 5: Ordered with Closed\n- type=\"ordered\", criterion=\"ordered\", closed=true\n- Verify no matrix calculation\n- Verify last waypoint is origin\n\n### Test 6: Endpoint in Excluded Zone\n- Define endpoint that's inside exclude zone\n- Verify warning logged\n- Verify route succeeds with remaining waypoints\n\n## Future Enhancements\n\n1. **Multiple Endpoints**: Support routes that must visit specific waypoints in any order but end at one of several designated endpoints\n\n2. **Multiple Depots**: Support starting from one depot and ending at another\n\n3. **Time Windows**: Add time constraints (e.g., \"must end by 17:00\")\n\n4. **Vehicle Capacity**: Extend to vehicle routing with capacity constraints\n\n5. **Soft Constraints**: Make endpoint \"preferred\" rather than required\n"}}]